<!--Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可-->

## 最大后验概率估计与贝叶斯估计

https://www.jianshu.com/p/9c153d82ba2d

## 最大后验概率估计

简称MAP（Maximum Posteriori Estimation）。

问题：有50个白球，50个黑球，在一个袋子里，从中任意拿出10个球，放到第二个袋子里，再从第二个袋子里抽取一个球，记录颜色，放回，再抽取，重复10次。结果一共抽取到7次白球，3次黑球，求最大似然和最大后验概率。

问题：有一枚匀质硬币，投10次，7次正面向上，求

利用前面学到的知识，求解最大似然函数：

$$
L(X;\theta)= \theta^7 (1-\theta)^3 \tag{1}
$$
解得：
$$
\theta_{max}=0.7
$$

<img src="Images/likelihood_berno.png"/>

意味着有10个球里最可能有6个白球和4个黑球，但是我们知道从第一个袋子里拿出10个球的最大概率是5个白球和5个黑球，也就是先验分布值为0.5，而不是0.6，这违背了人们的常识。

其实$\theta_{max}=0.6$这件事，并不是说$\theta=0.6$，而是说 $\theta$ 的最可能的值是0.6，还有可能是别的值。这时，我们如果把先验分布知识加进来，是不是能够在一定程度上让 $\theta$ 值接近0.5呢？这就是最大后验概率估计的想法。

提到后验概率，我们想到了前面学过的后验概率中的贝叶斯定理，把公式中的 $A、B$ 换成 $X、\theta$，可以得到公式5：

$$
P(\theta|X)=\frac{P(X|\theta)P(\theta)}{P(X)} \tag{2}
$$

其中：

- $P(\theta|X)$ 是后验分布；
- $P(X|\theta)$ 是似然函数，也就是公式4中的 $L(X;\theta)$，写成$P(X|\theta)$是为了与贝叶斯公式的命名规则相吻合；
- $P(\theta)$ 是先验分布，即$\theta=0.5$时的概率分布；
- $P(X)$ 是采样概率，在一次试验中该值是固定的，所以可以在公式5中忽略。

如此一来，估算最大后验概率 $P(\theta|X)$ 的任务变成了：

$$
\argmax_\theta P(\theta|X)=\argmax_\theta \frac{P(X|\theta)P(\theta)}{P(X)} \propto \argmax_\theta P(X|\theta)P(\theta) \tag{3}
$$

在公式6中，$P(X|\theta)$ 是似然函数，我们如果再知道 $P(\theta)$ 的先验概率表达式，就可以得到结果了。

### 共轭分布与共轭先验

在贝叶斯统计中，如果后验分布与先验分布属于同类，则先验分布与后验分布被称为共轭分布，而先验分布被称为似然函数的共轭先验（Conjugate prior）。比如，高斯分布家族在高斯似然函数下与其自身共轭（自共轭），而我们在本节的问题中遇到的伯努利分布的共轭先验分布是B分布。

采用共轭先验，使得先验分布和后验分布的形式相同，这样一方面合符人的直观（它们应该是相同形式的）另外一方面是可以形成一个先验链，即现在的后验分布可以作为下一次计算的先验分布，如果形式相同，就可以形成一个链条。

### B分布

在概率论中，B分布也称$Beta分布（Beta Distribution），是只一组定义在（0,1）区间的连续概率分布，有两个参数 $\alpha，\beta >0$，其概率密度函数是：

$$
f(x;\theta) = \frac{\Gamma(\alpha+\beta)}{\Gamma(\alpha)\Gamma(\beta)}\theta^{\alpha-1}(1-\theta)^{\beta-1} \tag{4}
$$

其中Gamma函数形式为：

$$
\Gamma(x)=\int_0^\infty \frac{t^{x-1}}{e^t}dt, (x>0) \tag{5}
$$

当 $x$ 为整数 $n$ 时：

$$
\Gamma(n)=(n-1)! \tag{6}
$$

B分布的概率密度函数图：

<img src="Images/BetaDist.png"/>


先验分布为Beta分布



我们取$\alpha=3，\beta=3$，

$$
\begin{aligned}
MAP &= P(X|\theta)P(\theta)=L(X;\theta) \times f(x;\theta) \\
&=\theta^7 (1-\theta)^3 \times \frac{\Gamma(\alpha+\beta)}{\Gamma(\alpha)\Gamma(\beta)}\theta^{\alpha-1}(1-\theta)^{\beta-1} \\
&=\frac{\Gamma(\alpha+\beta)}{\Gamma(\alpha)\Gamma(\beta)}\theta^{\alpha+6}(1-\theta)^{\beta+2}
\end{aligned} \tag{7}
$$

对$MAP$求导，并令其结果为0：

$$
\frac{d MAP}{d \theta}=(\alpha+6)\theta^{\alpha+5}(1-\theta)^{\beta+2}-(\beta+2)\theta^{\alpha+6}(1-\theta)^{\beta+1}=0
$$

解得：
$$
\theta = \frac{\alpha + 6}{\alpha+\beta+8}=\frac{3+6}{3+3+8} \approx 0.643
$$

<img src="Images/map_berno.png"/>

可以看到经过先验概率的矫正后，参数值已经从以前的最大似然估计的0.7变成了0.643，向0.5的方向靠近了一些，但是不可能达到0.5的，因为本次的采样就是7个白球3个黑球，太偏了。解决此问题的方法是多做几次试验，相当于增加采用数量，就会向真实的概率值逼近。

## 贝叶斯估计

贝叶斯估计是最大后验估计的进一步扩展，贝叶斯估计同样假定是一个随机变量，但贝叶斯估计并不是直接估计出的某个特定值，而是估计的分布，这是贝叶斯估计与最大后验概率估计不同的地方。在贝叶斯估计中，先验分布是不可忽略的。回到抛硬币的例子中，在已知的情况下，描述的分布即描述，是一种后验分布。如果后验分布的范围较窄，则估计值的准确度相对较高，反之，如果后验分布的范围较广，则估计值的准确度就较低。

$$
P(\theta|X)=\frac{P(X|\theta)P(\theta)}{P(X)} \tag{8}
$$

在连续型随机变量中，$P(X)$可以展开成下面的形式：

$$
P(\theta|X)=\frac{P(X|\theta)P(\theta)}{\int P(X|\theta)P(\theta)d\theta} \tag{9}
$$

但是求分母的积分是不可能的，如果使用共轭先验分布，就可以解决此问题。二项分布参数数的共轭先验是Beta分布，由于\theta的似然函数服从二项分布，因此在贝叶斯估计中，假设\theta的先验分布服从P(\theta)\sim Beta(\alpha, \beta)，Beta分布的概率密度为公式4，把它代入分母中，可以得到如下形式：

$$
\begin{aligned}
P(\theta|X)&=\frac{\theta^7(1-\theta)^3 \theta^{\alpha-1} (1-\theta)^{\beta-1}/B(\alpha,\beta)}{\int [\theta^7(1-\theta)^3 \theta^{\alpha-1} (1-\theta)^{\beta-1}/B(\alpha,\beta)] d\theta} \\
&=\frac{\theta^{\alpha+7-1}(1-\theta)^{\beta+3-1}}{B(\alpha+7-1,\beta+3-1)} \\
&=Beta(\theta|\alpha+6,\beta+2)
\end{aligned}
$$

从上面的公式可以看出，。其中B函数，也称Beta函数，是一个标准化常量，用来使整个概率的积分为1。$Beta(\theta|\alpha+6,\beta+2)$就是贝叶斯估计的结果。

如果使用贝叶斯估计得到的分布存在一个有限均值，则可以用后验分布的期望作为的估计值。假设，在这种情况下，先验分布会在处取得最大值，则，的曲线如下图：

【图】

注：二项分布参数的共轭先验是Beta分布，多项式分布参数的共轭先验是Dirichlet分布，指数分布参数的共轭先验是Gamma分布，⾼斯分布均值的共轭先验是另⼀个⾼斯分布，泊松分布的共轭先验是Gamma分布。


贝叶斯估计的求解步骤：

确定参数的似然函数
确定参数的先验分布，应是后验分布的共轭先验
确定参数的后验分布函数
根据贝叶斯公式求解参数的后验分布
